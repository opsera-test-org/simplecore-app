name: "Diagnostics - simplecore14"

on:
  workflow_dispatch:

env:
  TENANT: opsera
  APP_NAME: simplecore14
  ENV: dev
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  NAMESPACE: opsera-simplecore14-dev

permissions:
  contents: read
  id-token: write

jobs:
  diagnose:
    name: Full Deployment Diagnostics
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure Cluster Access
        run: |
          aws eks update-kubeconfig --name ${SPOKE_CLUSTER} --region ${AWS_REGION} --alias spoke
          kubectl config use-context spoke

      - name: "1. Check Namespace"
        run: |
          echo "================================"
          echo "1. NAMESPACE CHECK"
          echo "================================"
          kubectl get namespace ${NAMESPACE} || echo "❌ Namespace not found!"
          echo ""

      - name: "2. Check Pods"
        run: |
          echo "================================"
          echo "2. PODS STATUS"
          echo "================================"
          kubectl get pods -n ${NAMESPACE} -o wide || echo "❌ No pods found!"
          echo ""
          echo "Pod Details:"
          kubectl describe pods -n ${NAMESPACE} || echo "❌ Cannot describe pods"
          echo ""

      - name: "3. Check Deployment"
        run: |
          echo "================================"
          echo "3. DEPLOYMENT STATUS"
          echo "================================"
          kubectl get deployment ${APP_NAME} -n ${NAMESPACE} || echo "❌ Deployment not found!"
          echo ""
          kubectl describe deployment ${APP_NAME} -n ${NAMESPACE} || echo "❌ Cannot describe deployment"
          echo ""

      - name: "4. Check Service"
        run: |
          echo "================================"
          echo "4. SERVICE STATUS"
          echo "================================"
          kubectl get service ${APP_NAME} -n ${NAMESPACE} || echo "❌ Service not found!"
          echo ""
          kubectl describe service ${APP_NAME} -n ${NAMESPACE} || echo "❌ Cannot describe service"
          echo ""

      - name: "5. Check Ingress"
        run: |
          echo "================================"
          echo "5. INGRESS STATUS"
          echo "================================"
          kubectl get ingress ${APP_NAME} -n ${NAMESPACE} || echo "❌ Ingress not found!"
          echo ""
          kubectl describe ingress ${APP_NAME} -n ${NAMESPACE} || echo "❌ Cannot describe ingress"
          echo ""

      - name: "6. Check Ingress Controller"
        run: |
          echo "================================"
          echo "6. INGRESS CONTROLLER CHECK"
          echo "================================"
          echo "Checking for NGINX Ingress Controller..."
          kubectl get pods -n ingress-nginx 2>/dev/null || echo "⚠️  NGINX Ingress Controller namespace not found"
          echo ""
          kubectl get svc -n ingress-nginx 2>/dev/null || echo "⚠️  No ingress controller service found"
          echo ""

      - name: "7. Check ECR Secret"
        run: |
          echo "================================"
          echo "7. ECR PULL SECRET"
          echo "================================"
          kubectl get secret ecr-pull-secret -n ${NAMESPACE} || echo "❌ ECR pull secret not found!"
          echo ""

      - name: "8. Check Events"
        run: |
          echo "================================"
          echo "8. RECENT EVENTS"
          echo "================================"
          kubectl get events -n ${NAMESPACE} --sort-by='.lastTimestamp' | tail -20
          echo ""

      - name: "9. Check Pod Logs"
        continue-on-error: true
        run: |
          echo "================================"
          echo "9. POD LOGS (Last 50 lines)"
          echo "================================"
          POD_NAME=$(kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          if [ -n "$POD_NAME" ]; then
            echo "Logs from pod: $POD_NAME"
            kubectl logs $POD_NAME -n ${NAMESPACE} --tail=50 || echo "❌ Cannot get logs"
          else
            echo "❌ No pods found to get logs from"
          fi
          echo ""

      - name: "10. Test Internal Connectivity"
        continue-on-error: true
        run: |
          echo "================================"
          echo "10. INTERNAL CONNECTIVITY TEST"
          echo "================================"
          POD_NAME=$(kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          if [ -n "$POD_NAME" ]; then
            echo "Testing health endpoint from within cluster..."
            kubectl exec $POD_NAME -n ${NAMESPACE} -- wget -O- http://localhost:8080/health 2>/dev/null || echo "❌ Health check failed"
          else
            echo "❌ No pods found to test connectivity"
          fi
          echo ""

      - name: "11. ArgoCD Application Status"
        run: |
          echo "================================"
          echo "11. ARGOCD APPLICATION"
          echo "================================"
          aws eks update-kubeconfig --name ${HUB_CLUSTER} --region ${AWS_REGION} --alias hub
          kubectl --context hub get application ${TENANT}-${APP_NAME}-${ENV} -n argocd -o yaml || echo "❌ ArgoCD application not found!"
          echo ""

      - name: "12. Summary & Recommendations"
        run: |
          echo "================================"
          echo "12. DIAGNOSTIC SUMMARY"
          echo "================================"
          echo ""
          echo "Common Issues & Solutions:"
          echo ""
          echo "1. If Ingress Controller is missing:"
          echo "   - Install NGINX Ingress Controller on the cluster"
          echo "   - Run: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml"
          echo ""
          echo "2. If DNS is not resolving:"
          echo "   - Configure DNS A record for simplecore14-dev.agent.opsera.dev"
          echo "   - Point to the Ingress Controller LoadBalancer IP"
          echo ""
          echo "3. If TLS certificate is missing:"
          echo "   - Install cert-manager on the cluster"
          echo "   - Configure ClusterIssuer for Let's Encrypt"
          echo ""
          echo "4. If pods are not running:"
          echo "   - Check pod logs above for errors"
          echo "   - Verify ECR pull secret is valid"
          echo "   - Check image exists in ECR"
          echo ""
          echo "5. For internal testing (bypass ingress):"
          echo "   - Use port-forward: kubectl port-forward -n ${NAMESPACE} svc/${APP_NAME} 8080:80"
          echo "   - Then access: http://localhost:8080"
          echo ""
